#!/usr/bin/env node

const path = require("path");

const program = require("commander");
const chalk = require("chalk");
const boxen = require("boxen");
const coIM = require("../src/index");

const toFixed = number => number.toFixed(2);

let inputTotalSize = 0,
    outputTotalSize = 0;

program
    .version(require("../package").version, "-v, --version")
    /**
     *  是否递归转文件夹化
     */
    .option("-r, --recursion", "is recursion or not")
    /**
     * 压缩文件放入新文件夹
     */
    .option("-p, --removePath <a>", "down path")
    .action(async () => {
        const { recursion, removePath } = program;

        coIM({
            recursion,
            removePath,
            itemSuccess: ({ saveName, input, output }) => {
                const is = input.size;
                const os = output.size;
                inputTotalSize += is;
                outputTotalSize += os;
                console.log(
                    `${chalk.blue(saveName)}\n`,
                    `${toFixed(is / 1024)} kb => ${toFixed(os / 1024)} kb,  压缩了： ${chalk.green(toFixed(((is - os) / is) * 100) + "%")}\n`
                );
            },
            allSuccess: () => {
                if (inputTotalSize === 0) {
                    console.log(chalk.red(`该路径下无可压缩文件`));
                    return;
                }
                console.log(
                    chalk.green(
                        boxen(`\n压缩完毕， 总共优化体积: ${toFixed(((inputTotalSize - outputTotalSize) / inputTotalSize) * 100)}%`, {
                            padding: 1,
                            borderStyle: "double"
                        })
                    )
                );
            }
        });
    });

program.parse(process.argv);
